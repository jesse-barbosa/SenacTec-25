<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EcoColeta</title>
<link rel="stylesheet" href="css/index.css">
</head>

<body>
<div id="app">

    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <img src="img/ecocoleta_logo.png" class="logo" height="60" width="60" alt="EcoColeta" />
            <div class="title">EcoColeta</div>
        </div>
        <a href="form-adm.html" class="btn btn-blue link-btn">Painel ADM</a>
    </header>

    <!-- Main Content -->
    <main>
        <h1 class="page-title">Agende sua Coleta de Recicláveis</h1>

        <form id="coleta-form" class="form-card">

            <!-- Dados pessoais -->
            <div class="form-section">
                <label for="nome">Nome</label>
                <input type="text" id="nome" name="nome" placeholder="Seu nome" required>

                <label for="email">E-mail</label>
                <input type="email" id="email" name="email" placeholder="Seu e-mail" required>

                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" name="telefone" placeholder="(XX) XXXX-XXXX" required>
            </div>

            <!-- Endereço -->
            <div class="form-section">
                <label for="rua">Rua / Número</label>
                <div class="input-row">
                    <input type="text" id="rua" name="rua" placeholder="Rua" required>
                    <input type="text" id="numero" name="numero" placeholder="Número" required>
                </div>

                <label for="bairro">Bairro / Cidade</label>
                <div class="input-row">
                    <input type="text" id="bairro" name="bairro" placeholder="Bairro" required>
                    <input type="text" id="cidade" name="cidade" placeholder="Cidade" required>
                </div>
            </div>

            <!-- Data de coleta -->
            <div class="form-section">
                <label for="data_coleta">Data sugerida para coleta</label>
                <input type="date" id="data_coleta" name="data_coleta" required>
            </div>

            <!-- Tipo de material -->
            <div class="form-section">
                <label>Tipo de material para coleta</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="material[]" value="Eletrônicos"> Eletrônicos</label>
                    <label><input type="checkbox" name="material[]" value="Metal"> Metal</label>
                    <label><input type="checkbox" name="material[]" value="Papel/Papelão"> Papel/Papelão</label>
                    <label><input type="checkbox" name="material[]" value="Plástico"> Plástico</label>
                    <label><input type="checkbox" name="material[]" value="Vidro"> Vidro</label>
                    <label><input type="checkbox" name="material[]" value="Óleo de cozinha"> Óleo de cozinha</label>
                </div>
            </div>

            <!-- Botão -->
            <div class="form-section form-btn">
                <button type="submit" class="btn btn-green">Solicitar Coleta</button>
            </div>
        </form>
    </main>
</div>

<script src="lib/jquery-3.7.0.min.js"></script>
<!-- Importando jsPDF + autotable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<script>
$(document).ready(function(){
    let opcoes = {};

    $(document).on("click", ".export-btn", function(){
        let opcao = $(this).data("opcao");
        opcoes[opcao]();
    });

    $('#coleta-form').on('submit', function(e){
        e.preventDefault();
        var data = $(this).serializeArray();

        // Função para gerar protocolo
        function gerarProtocolo(){
            let now = new Date();
            let ano = now.getFullYear();
            let mes = String(now.getMonth() + 1).padStart(2, "0");
            let dia = String(now.getDate()).padStart(2, "0");
            let hora = String(now.getHours()).padStart(2, "0");
            let min = String(now.getMinutes()).padStart(2, "0");
            let seg = String(now.getSeconds()).padStart(2, "0");

            // Gerar código aleatório de 4 chars (letras e números)
            let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let random = "";
            for(let i = 0; i < 4; i++){
                random += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            return `ECO-${ano}${mes}${dia}-${hora}${min}${seg}-${random}`;
        }

        let protocolo = gerarProtocolo();

        // Mapeamento de labels amigáveis
        const labels = {
            protocolo: "Protocolo",
            nome: "Nome",
            email: "E-mail",
            telefone: "Telefone",
            rua: "Rua",
            numero: "Número",
            bairro: "Bairro",
            cidade: "Cidade",
            data_coleta: "Data Coleta",
        };

        // Separar materiais e outros campos
        let materiais = [];
        let dadosFormatados = [
            { campo: "Protocolo", valor: protocolo }
        ];

        data.forEach(item => {
            if(item.name === "material[]"){
                materiais.push(item.value);
            } else {
                let label = labels[item.name] || item.name;
                dadosFormatados.push({ campo: label, valor: item.value });
            }
        });

        // Adicionar os materiais formatados
        if(materiais.length > 0){
            let labelMaterial = materiais.length > 1 ? "Materiais" : "Material";
            dadosFormatados.push({
                campo: labelMaterial,
                valor: materiais.join(", ")
            });
        }

        // Atualiza opções de exportação
        opcoes = {
            ".PDF": () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Título
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("Registro de Coleta", 105, 15, { align: "center" });

                // Protocolo
                doc.setFontSize(11);
                doc.setFont("helvetica", "italic");
                doc.text(`Protocolo: ${protocolo}`, 105, 22, { align: "center" });

                // Mensagem inicial
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text("Dados inseridos no formulário de solicitação de coleta:", 10, 32);

                // Criar tabela formatada
                let rows = dadosFormatados.map(item => [item.campo, item.valor]);

                doc.autoTable({
                    startY: 40,
                    head: [["Campo", "Valor"]],
                    body: rows,
                    styles: { font: "helvetica", fontSize: 11 },
                    headStyles: { fillColor: [41, 128, 185] },
                    alternateRowStyles: { fillColor: [240, 240, 240] },
                    margin: { left: 10, right: 10 }
                });

                // Rodapé com protocolo
                let pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(10);
                doc.setFont("helvetica", "italic");
                doc.text(`Protocolo: ${protocolo}`, 10, pageHeight - 10);

                // Baixar PDF
                doc.save(`formulario-${protocolo}.pdf`);
            },
            ".TXT": () => {
                let texto = "";
                dadosFormatados.forEach(item => {
                    texto += `${item.campo}: ${item.valor}\n`;
                });

                let blob = new Blob([texto], { type: "text/plain" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `formulario-${protocolo}.txt`;
                link.click();
            },
            ".JSON": () => {
                let dadosJson = {
                    protocolo,
                    dados: dadosFormatados.map(item => ({ [item.campo]: item.valor }))
                };

                let blob = new Blob([JSON.stringify(dadosJson)], { type: "application/json" });
                let link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `formulario-${protocolo}.json`;
                link.click();
            }
        };
        
        let opcoesHtml = Object.keys(opcoes).map(opcao => 
            `<button class="btn btn-outline export-btn" data-opcao="${opcao}">${opcao}</button>`
            ).join(" ");

        let janela = `
            <div class="export-window">
                <div class="export-title">
                    Exportar para:
                    <button class="close-btn" onClick="$('.export-window').fadeOut(200)">
                        X
                    </button>
                </div>
                <div class="export-options">${opcoesHtml}</div>
            </div>
        `;

        $("body").append(janela);
        $(".export-window").fadeIn(200);
    });
});

</script>
</body>
</html>