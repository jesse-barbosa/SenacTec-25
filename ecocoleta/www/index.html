<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EcoColeta</title>
<link rel="stylesheet" href="css/index.css">
</head>

<body>
<div id="app">

    <!-- Header -->
    <header class="header">
        <div class="logo-container">
            <img src="img/ecocoleta_logo.png" class="logo" height="60" width="60" alt="EcoColeta" />
            <div class="title">EcoColeta</div>
        </div>
        <a href="form-adm.html" class="btn btn-blue link-btn">Painel ADM</a>
    </header>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="agendar">Agendar Coleta</div>
            <div class="tab" data-tab="registros">Meus Registros</div>
        </div>

        <!-- Conteúdo das tabs -->
        <div class="tab-content active" id="agendar">
            <h1 class="page-title">Agende sua Coleta de Recicláveis</h1>
            <form id="coleta-form" class="form-card">

                <!-- Dados pessoais -->
                <div class="form-section">
                    <label for="nome">Nome</label>
                    <input type="text" id="nome" name="nome" placeholder="Seu nome" required>

                    <label for="email">E-mail</label>
                    <input type="email" id="email" name="email" placeholder="Seu e-mail" required>

                    <label for="telefone">Telefone</label>
                    <input type="text" id="telefone" name="telefone" placeholder="(XX) XXXX-XXXX" required>
                </div>

                <!-- Endereço -->
                <div class="form-section">
                    <label for="rua">Rua / Número</label>
                    <div class="input-row">
                        <input type="text" id="rua" name="rua" placeholder="Rua" required>
                        <input type="text" id="numero" name="numero" placeholder="Número" required>
                    </div>

                    <label for="bairro">Bairro / Cidade</label>
                    <div class="input-row">
                        <input type="text" id="bairro" name="bairro" placeholder="Bairro" required>
                        <input type="text" id="cidade" name="cidade" placeholder="Cidade" required>
                    </div>
                </div>

                <!-- Data de coleta -->
                <div class="form-section">
                    <label for="data_coleta">Data sugerida para coleta</label>
                    <input type="date" id="data_coleta" name="data_coleta" required>
                </div>

                <!-- Tipo de material -->
                <div class="form-section">
                    <label>Tipo de material para coleta</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="material[]" value="Eletrônicos"> Eletrônicos</label>
                        <label><input type="checkbox" name="material[]" value="Metal"> Metal</label>
                        <label><input type="checkbox" name="material[]" value="Papel/Papelão"> Papel/Papelão</label>
                        <label><input type="checkbox" name="material[]" value="Plástico"> Plástico</label>
                        <label><input type="checkbox" name="material[]" value="Vidro"> Vidro</label>
                        <label><input type="checkbox" name="material[]" value="Óleo de cozinha"> Óleo de cozinha</label>
                    </div>
                </div>

                <!-- Botão -->
                <div class="form-section form-btn btn-container">
                    <button type="submit" class="btn-green">Solicitar Coleta</button>
                </div>
            </form>
        </div>

        <div class="tab-content" id="registros">
            <h1 class="page-title">Meus Registros</h1>
            <div id="lista-registros"></div>
        </div>

    </main>
</div>

<!-- Janela de exportação -->
<div class="export-window">
    <div class="export-title">
        Exportar para:
        <button class="close-btn">X</button>
    </div>
    <div class="export-options"></div>
</div>

<script src="lib/jquery-3.7.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<script>
$(document).ready(function(){
    $(document).on('click', '.tab', function() {
        const target = $(this).data('tab');
        $('.tab').removeClass('active');
        $(this).addClass('active');
        $('.tab-content').removeClass('active');
        $('#' + target).addClass('active');
    });

    // --- mesma lógica de data mínima ---
    let hoje = new Date();
    hoje.setDate(hoje.getDate() + 3);
    let ano = hoje.getFullYear();
    let mes = String(hoje.getMonth() + 1).padStart(2, "0");
    let dia = String(hoje.getDate()).padStart(2, "0");
    let dataMin = `${ano}-${mes}-${dia}`;
    $("#data_coleta").attr("min", dataMin);

    // Variáveis
    let exportRegistroData = null;
    let cordovaReady = false;

    // Função simples de feedback (toast visual)
    function showFeedback(msg, tempo=3500){
        // remove toast antigo
        $('.ecotoast').remove();
        const toast = $(`<div class="ecotoast">${msg}</div>`).css({
            position:'fixed', left:'50%', transform:'translateX(-50%)',
            bottom:'24px', padding:'10px 16px', 'background-color':'#2d9cdb',
            color:'#fff', 'border-radius':'8px', 'z-index':9999, 'box-shadow':'0 4px 12px rgba(0,0,0,0.2)'
        });
        $('body').append(toast);
        setTimeout(()=>toast.fadeOut(300, ()=>toast.remove()), tempo);
    }

    // Deviceready (Cordova)
    document.addEventListener('deviceready', function() {
        cordovaReady = true;
        console.log('deviceready ✅ plugins?', {
            file: !!cordova.file,
            resolver: !!window.resolveLocalFileSystemURL,
            opener2: !!(cordova.plugins && cordova.plugins.fileOpener2),
            permissions: !!(cordova.plugins && cordova.plugins.permissions)
        });

        // pedir permissão READ/WRITE caso plugin exista (Android < 11; não faz mal pedir)
        if (cordova.plugins && cordova.plugins.permissions) {
            const perms = cordova.plugins.permissions;
            perms.checkPermission(perms.WRITE_EXTERNAL_STORAGE, function(status) {
                if (!status.hasPermission) {
                    perms.requestPermission(perms.WRITE_EXTERNAL_STORAGE, function(s){ console.log('WRITE perm granted?', s); }, function(){ console.warn('WRITE perm denied'); });
                }
            }, function(err){
                console.warn('checkPermission erro', err);
            });
        }
    }, false);

    // Função que salva Blob numa fileEntry e resolve o caminho (usa nativeURL)
    function salvarArquivo(nomeArquivo, blob) {
        return new Promise((resolve, reject) => {
            if (!cordovaReady || !window.resolveLocalFileSystemURL || !cordova.file) {
                return reject(new Error('Cordova ou plugin de arquivos não disponível'));
            }
            const dirPath = cordova.file.externalDataDirectory || cordova.file.dataDirectory;
            console.log('salvando em', dirPath + nomeArquivo);

            window.resolveLocalFileSystemURL(dirPath, function(dirEntry) {
                dirEntry.getFile(nomeArquivo, { create: true }, function(fileEntry) {
                    fileEntry.createWriter(function(fileWriter) {
                        fileWriter.onwriteend = function() {
                            // prefer nativeURL; se não, usar toURL()
                            const url = fileEntry.nativeURL || fileEntry.toURL();
                            console.log('arquivo escrito, url:', url);
                            resolve(url);
                        };
                        fileWriter.onerror = function(e) {
                            console.error('fileWriter error', e);
                            reject(e);
                        };
                        fileWriter.write(blob);
                    }, function(err){ console.error('createWriter err', err); reject(err); });
                }, function(err){ console.error('getFile err', err); reject(err); });
            }, function(err){ console.error('resolveLocalFileSystemURL err', err); reject(err); });
        });
    }

    // Tenta abrir com fileOpener2; se falhar, mostra feedback com o caminho
    function abrirArquivo(caminho, mime) {
        if (window.cordova && cordova.plugins && cordova.plugins.fileOpener2) {
            cordova.plugins.fileOpener2.open(
                caminho,
                mime,
                {
                    error: function(e) {
                        console.warn('fileOpener2 erro', e);
                        // tentar variações: com/sem file://
                        if (!caminho.startsWith('file://')) {
                            const alt = 'file://' + caminho;
                            cordova.plugins.fileOpener2.open(alt, mime, {
                                error: function(e2){ console.error('tentativa alt também falhou', e2); showFeedback('Arquivo salvo: ' + caminho); },
                                success: function(){ console.log('aberto com alt'); }
                            });
                        } else {
                            showFeedback('Arquivo salvo: ' + caminho);
                        }
                    },
                    success: function() { console.log('Arquivo aberto com sucesso'); }
                }
            );
        } else {
            console.log('fileOpener2 não disponível. Arquivo em:', caminho);
            showFeedback('Arquivo salvo em: ' + caminho);
        }
    }

    // Função principal de exportação
    async function baixarRegistro(formato, registro){
        try {
            let protocolo = registro.find(r=>r.campo==="Protocolo").valor;

            if(formato === ".PDF"){
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont("helvetica","bold"); doc.setFontSize(16);
                doc.text("Registro de Coleta",105,15,{align:"center"});
                doc.setFont("helvetica","italic"); doc.setFontSize(11);
                doc.text(`Protocolo: ${protocolo}`,105,22,{align:"center"});
                doc.setFont("helvetica","normal"); doc.setFontSize(12);
                doc.text("Dados inseridos no formulário de solicitação de coleta:",10,32);

                let rows = registro.map(i=>[i.campo,i.valor]);
                doc.autoTable({
                    startY:40,
                    head:[["Campo","Valor"]],
                    body:rows,
                    styles:{font:"helvetica",fontSize:11},
                    headStyles:{fillColor:[41,128,185]},
                    alternateRowStyles:{fillColor:[240,240,240]},
                    margin:{left:10,right:10}
                });

                let pageHeight = doc.internal.pageSize.height;
                doc.setFontSize(10); doc.setFont("helvetica","italic");
                doc.text(`Protocolo: ${protocolo}`,10,pageHeight-10);

                if (cordovaReady) {
                    // gerar blob e salvar
                    let pdfBlob = doc.output("blob");
                    const nome = `formulario-${protocolo}.pdf`;
                    showFeedback('Salvando PDF...');
                    const caminho = await salvarArquivo(nome, pdfBlob);
                    showFeedback('PDF salvo');
                    abrirArquivo(caminho, 'application/pdf');
                } else {
                    // fallback navegador
                    doc.save(`formulario-${protocolo}.pdf`);
                    showFeedback('Download iniciado (navegador)');
                }
            }
            else if(formato === ".TXT"){
                let texto = registro.map(i=>`${i.campo}: ${i.valor}`).join("\n");
                let blob = new Blob([texto],{type:"text/plain"});
                const nome = `formulario-${protocolo}.txt`;
                if (cordovaReady) {
                    showFeedback('Salvando TXT...');
                    const caminho = await salvarArquivo(nome, blob);
                    showFeedback('TXT salvo');
                    abrirArquivo(caminho, 'text/plain');
                } else {
                    let link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = nome;
                    link.click();
                    showFeedback('Download iniciado (navegador)');
                }
            }
            else if(formato === ".JSON"){
                let dadosJson = {protocolo, dados: registro.map(i=>({[i.campo]:i.valor}))};
                let blob = new Blob([JSON.stringify(dadosJson,null,2)],{type:"application/json"});
                const nome = `formulario-${protocolo}.json`;
                if (cordovaReady) {
                    showFeedback('Salvando JSON...');
                    const caminho = await salvarArquivo(nome, blob);
                    showFeedback('JSON salvo');
                    abrirArquivo(caminho, 'application/json');
                } else {
                    let link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = nome;
                    link.click();
                    showFeedback('Download iniciado (navegador)');
                }
            }
        } catch (err) {
            console.error('Erro em baixarRegistro:', err);
            alert('Erro ao exportar: ' + (err && err.message ? err.message : JSON.stringify(err)));
        }
    }

    // restante do seu código (forms, salvarRegistro, lista, etc.)
    function gerarProtocolo(){
        let now = new Date();
        let ano = now.getFullYear();
        let mes = String(now.getMonth()+1).padStart(2,"0");
        let dia = String(now.getDate()).padStart(2,"0");
        let hora = String(now.getHours()).padStart(2,"0");
        let min = String(now.getMinutes()).padStart(2,"0");
        let seg = String(now.getSeconds()).padStart(2,"0");
        let chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let random = "";
        for(let i=0;i<4;i++){ random += chars.charAt(Math.floor(Math.random()*chars.length)); }
        return `ECO-${ano}${mes}${dia}-${hora}${min}${seg}-${random}`;
    }

    function salvarRegistro(dados){
        let registros = JSON.parse(localStorage.getItem('registros')) || [];
        registros.push(dados);
        localStorage.setItem('registros', JSON.stringify(registros));
        atualizarListaRegistros();
    }

    function atualizarListaRegistros(){
        let registros = JSON.parse(localStorage.getItem('registros')) || [];
        let html = '';
        registros.forEach((registro,index)=>{
            html += `<div class="record-card">`;
            registro.forEach(item=>{
                html += `<div><strong>${item.campo}:</strong> ${item.valor}</div>`;
            });
            html += `<button class="btn-outline export-btn" data-index="${index}">Exportar</button>`;
            html += `</div>`;
        });
        $('#lista-registros').html(html);
    }

    $('#coleta-form').on('submit',function(e){
        e.preventDefault();
        let data = $(this).serializeArray();
        let protocolo = gerarProtocolo();

        const labels = {protocolo:"Protocolo", nome:"Nome", email:"E-mail", telefone:"Telefone", rua:"Rua", numero:"Número", bairro:"Bairro", cidade:"Cidade", data_coleta:"Data Coleta"};
        let materiais = [], dadosFormatados=[{campo:"Protocolo", valor:protocolo}];
        data.forEach(item=>{if(item.name==="material[]"){materiais.push(item.value)}else{let label=labels[item.name]||item.name; dadosFormatados.push({campo:label, valor:item.value});}});
        if(materiais.length>0){dadosFormatados.push({campo: materiais.length>1?"Materiais":"Material", valor: materiais.join(", ")});}
        salvarRegistro(dadosFormatados);
        $('#coleta-form')[0].reset();
        $('body').prepend(`<div class="success-msg">Sua coleta foi agendada com sucesso!</div>`);
        setTimeout(()=>$('.success-msg').fadeOut(500,function(){$(this).remove();}),3000);

        // Vai para registros
        $('.tab').removeClass('active'); $('.tab[data-tab="registros"]').addClass('active');
        $('.tab-content').removeClass('active'); $('#registros').addClass('active');
    });

    // Abrir janela de exportação
    $(document).on('click','.record-card .export-btn', function(){
        let index = $(this).data('index');
        let registros = JSON.parse(localStorage.getItem('registros')) || [];
        exportRegistroData = registros[index];

        let opcoesHtml = [".PDF",".TXT",".JSON"].map(opcao=>`<button class="btn btn-outline export-option" data-opcao="${opcao}">${opcao}</button>`).join(" ");
        $('.export-options').html(opcoesHtml);
        $('.export-window').fadeIn(200);
    });

    // Fechar janela
    $('.close-btn').click(function(){ $('.export-window').fadeOut(200); });

    // Exportar selecionando formato
    $(document).on('click','.export-option', function(){
        let formato = $(this).data('opcao');
        if(exportRegistroData) baixarRegistro(formato, exportRegistroData);
        $('.export-window').fadeOut(200);
    });

    // Inicializar registros
    atualizarListaRegistros();
});
</script>
</body>
</html>
